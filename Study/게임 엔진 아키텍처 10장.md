# 게임 엔진 아키텍처를 읽고 배운 것 (10장)

- 테셀레이션  
  - 테셀레이션이란 표면을 여러 개의 분할된 다각형(보통 삼각형)으로 쪼개는 과정이다.

  - 고정된 테셀레이션을 사용할 시 물체의 윤곽이 거칠게 보이는 단점이 있다. 이를 해결하기 위해 카메라와의 거리에 따라서 메시의 픽셀 밀도를 바꾸는 Level Of Detail(LOD)을 사용한다. LOD를 구현하는 방법은 2가지가 있다.
    - 픽셀 밀도가 다른 메시를 여러 벌 만드는 방법이 있다.
    - 고밀도 메시를 하나 만든 뒤, 거리가 멀어지면 메시의 모서리를 없애는 방법이 있다. 이를 점진적 메시(Progressive Mesh)라 한다.

- 메시 정점 리스트  
  - 메시를 정의하기 위해서는 메시를 이루는 정점을 표현해야 한다. 이 방법에는 여러가지가 있다.

  - 제일 기본적인 방법으로, 정점을 세개씩 묶어 리스트로 나타는 것이다. 이 방식의 단점으로는 정점이 중복되는 경우가 많아 메모리가 많이 낭비된다는 것이다.

  - 이를 해결하기 위해서 정점은 중복 없이 나열한 후, 인덱스로만 정의하는 것이다. 이 방법 역시 중복이 있지만, 수 많은 메타 데이터를 저장해야 하는 정점에 비해, 단순한 인덱스이므로 효율적으로 저장할 수 있다.

  - 삼각형 스트립과 삼각형 팬이라는 자료 구조도 있다.
    - 스트립은 첫 정점 3개는 삼각형을 이루고, 이 후 정점은 앞의 정점 2개와 삼각형을 이루는 자료 구조이다.
    - 팬은 첫 정점 3개는 삼각형을 이루고, 이 후 정점은 최초 정점, 그리고 바로 앞의 정점과 삼각형을 이루는 자료 구조이다.

  - GPU는 정점 셰이더를 거친 정점을 캐시에 저장해 재사용한다. 이런 면에서 스트립과 팬은 캐시 일관성을 높일 수 있다는 장점이 존재한다. 그러나 무조건 스트립이나 팬을 쓰지 않아도 정점 캐시 최적화 도구라는 오프라인 툴을 활용해 속도를 향상 시킬 수 있다.
  
- 빛
  - 빛의 색은 강도 I와 파장 λ로 나타낸다.

  - 광선이 각 주파수를 얼마나 포함하는지 그래프로 나타낸 것을 스펙트럼표라고 한다.
  
  - 빛과 물질 간 상호작용
    - 매질과 서로 다른 매질 사이의 경계면의 모양과 속성에 영향을 받는다.

    - 빛은 흡수, 반사, 굴절, 회절만을 한다. (보통 흡수, 반사, 굴절만을 고려한다.)

    - 빛이 반사하면 모든 방향으로 균등하게 퍼지는 난반사(Diffuse)를 하고, 반사광은 그대로 반사되거나, 좁게 퍼지는 정반사(Specular)를 한다.

    - 빛이 비등방(Anisotropic, 방향에 따라 물체의 물리적 성질이 다른 것)일 경우, 산란되거나, 부분적으로 흡수되거나, 굴절된다. 굴절각은 파장에 따라 달라지고, 이로 인해 스펙트럼 확산이 발생한다.

    - 피부 같은 재질에서 피부 안쪽의 재질이나 색깔이 밖으로 비쳐보이는 현상을 표면하산란(Subsurface Scattering)이라고 한다.

- 표면 정보  
  - 표면을 렌더링하려면 표면 법선 방향, 난반사 색상, 반사율, 질감, 투명도, 굴절 정보 같은 정보를 저장해야 한다. 그리고 빛의 작용을 처리하기 위해 빛에 대해 알아야 한다.

  - 보통 정점에 표면의 속성을 저장하는데, 이렇게 나타낸 표면 속성을 정점 속성(Vertex Attribute)이라고 한다. 보통 정점 속성은 다음의 속성들을 담는다.
    - 위치 벡터 : i번째 정점의 3D 위치 (모델 공간 기준)
    - 정점 법선 : i번째 정점의 표면 법선 (단위 벡터), 정점 단위 조명 계산에 사용
    - 정점 탄젠트 : 탄젠트 공간에서의 접선 벡터 T, 픽셀 단위 조명 계산에 사용
    - 바이 탄젠트 : 탄젠트 공간에서 T와 N을 외적한 값, 픽셀 단위 조명 계산에 사용
    - 난반사 색 : 표면의 난반사 색 (보통 Alpha 값을 포함)
    - 정반사 색 : 가상 카메라의 상표면에 맺히는 반사광의 색
    - UV 좌표 : 메시 표면에 붙을 텍스쳐의 좌표, 여러 개의 텍스쳐를 사용할 경우, 아래 첨자 j로 텍스쳐의 인덱스를 표시
    - 스키닝 가중치 : skeletal mesh일 경우 정점이 어느 관절에 연결되어 있고, 얼마나 영향을 받는지 나타내는 수치

- 정점 속성을 저장하는 자료 구조의 레이아웃을 정점 형식(Vertex Format)이라 한다. 만들 수 있는 정점 형식의 수는 이론적으로 무핸대고, 렌더링 엔진이 지원할 수 있는 정점 형식의 수는 한정되어 있기에 보통 일부만 사용할 수 있게 제한하거나, 모든 메시에 단 하나의 수퍼 포맷을 사용한다. (이는 GPU가 정점 자료구조에서 필요한 속성들을 뽑아 내는 기능이 있기에 가능하다.)

- 탄젠트 공간 (책에 안 나와서 인터넷 참조)

  - 접선 공간, 표면 공간, 텍스처 공간으로도 불린다.
  - 텍스처 위에서의 좌표계로, 법선 벡터 (수직 축), 접선 벡터, 바이노멀 벡터를 축으로 한다.

  - 참조한 인터넷 사이트
    - <http://blog.naver.com/PostView.nhn?blogId=sechs2&logNo=120065999816>
    - <https://mgun.tistory.com/1289>

- 셰이딩
  - 정점 속성을 스크린의 픽셀의 속성으로 변화하여 면에 색을 칠하는 것을 셰이딩이라 한다. 셰이딩에는 플랫 셰이딩(Flat Shading), 고로 셰이딩(Gouraud Shading), 퐁 셰이딩(Phong Shading) 등이 있다.
    - 플랫 셰이딩은 면의 법선벡터와 조명벡터로 면의 밝기를 계산한다. 면의 밝기를 계산하기에 물체가 각져보인다.
    - 고로 셰이딩은 정정의 법선벡터와 조명벡터로 정점의 밝기를 계산한다. 이렇게 구한 정점의 밝기를 선형 보간하여 픽셀의 밝기를 계산한다.
    - 퐁 셰이딩은 픽셀의 법선벡터와 조명벡터로 픽셀의 밝기를 계산한다.

- 텍스처
  - 정점 속성을 사용할 때 메시의 삼각형이 지나치게 크면 선형 보간 시 오차가 극명하게 드러나는 한계를 극복하기 위해 비트맵 이미지를 사용하는데 이를 텍스처 맵이라고 한다.

  - 텍스처의 기본 단위를 텍셀이라고 한다.

  - 난반사 맵, 알베도 맵 (PBR의 경우), 법선 맵, 글로스 맵, 환경 맵 등 여러 종류가 있으며, 조명 계산에 필요한 자료는 전부 텍스처에 저장할 수 있다. (1차원 텍스처로 수학 함수의 샘플링 값을 저장하는 것도 가능하다.)

  - 다양한 크기의 텍스처를 지원하기 위해 보통 텍스처 좌표는 (0, 0)에서 (1, 1)로 정규화 하여 사용한다.

  - 텍스처 좌표가 범위를 벗어날 경우 처리하는 방법을 텍스처 주소 지정 방식(Texture Addressing Mode)이라 한다. 4가지의 방법이 존재한다.
    - 반복(wrap) : 모든 방향으로 텍스처를 반복한다.
    - 거울(mirror) : u(v)가 범위를 벗어나는 경우 v(u) 방향으로 텍스처가 반사된다.
    - 고정(clamp) : 범위를 벗어나면 경계 색을 사용한다.
    - 경계 색(border color) : 범위를 벗어나면 사용자가 지정한 색을 사용한다.

  - 압축 텍스처는 비압축 텍스처보다 메모리도 적게 사용하고, 렌더링도 더 빠르다. 그러나 간혹 압축으로 이상하게 보이는 경우도 있다. 보통 눈에 잘 띄지는 않지만 압축 텍스처를 사용하면 안 되는 경우도 있다.

  - 텍셀 밀도와 밉맵
    - 텍셀과 텍스처가 차지하는 픽셀의 비율을 텍셀 밀도라고 한다. 텍셀 밀도는 카메라가 멀어지면 화면에서 차지하는 부분은 작아지나, 텍스처의 크기는 그대로이므로 텍셀 밀도가 커진다.  
  
    - 텍셀 밀도가 1보다 작아지면 텍셀의 경계가 보이므로 사실감이 떨어지고, 1보다 커지면 모이레 패턴이 발생할 수도 있고, 카메라의 위치가 각도가 변하면 색을 결정하는 텍셀이 바뀔 수도 있어 깜빡거릴 수도 있기에 텍셀 밀도를 1에 가깝게 유지해야 한다.

    - 텍셀 밀도를 1에 유지하기 위해 밉맵이라는 기법을 사용한다. LOD와 비슷한 기법으로 텍스처마다 해상도가 절반씩 낮아지는 비트맵을 만들고 (이 비트맵을 밉맵 혹은 밉 레벨이라고 한다.), 거리에 따라 적절한 밉 레벨을 선택한다.

    - 텍스처가 덮인 월드 공간 표면의 비율을 나타내는 **월드 공간 텍셀 밀도**라는 용어도 존재한다. 월드 공간 텍셀 밀도는 1에 맞출 필요는 없지만, 물체들이 일관된 월드 공간 텍셀 밀도를 갖게 해야한다.

    - 텍스처 맵을 샘플링할 때, 픽셀 하나가 텍셀 여러 부분에 해당할 때는 여러 텍스처를 샘플링해 이것들을 블렌딩해 최종 텍셀 색을 결정하는데, 이를 텍스처 필터링이라고 한다. 4가지의 방법이 존재한다.

      - 근접 샘플(Nearest Neighbor) 필터링 : 픽셀 중심과 가장 가까운 텍셀을 쓴다. 밉맵은 최적 해상도보다 큰 밉맵을 쓴다.

      - 이중선형(Bilinear) 필터링 : 픽셀을 둘러싼 네 개의 텍셀들을 샘플링해 이것들을 가중평균한다. 밉맵은 가장 가까운 밉맵을 쓴다.

      - 삼중선형(Trilinear) 필터링 : 가까운 두 밉맵 모두에 이중선형 필터링을 한 후, 그 결과를 선형 보간한다.

      - 비등방성(Anisotropic) 필터링 : 이중선형과 삼중선형이 비스듬히 볼 때는 자연스럽지 않기에, 바라보는 각도에 맞게 사다리꼴 영역에 들어가는 텍셀들을 샘플링해 품질을 향상한다.

- 머터리얼
  - 메시의 시각적인 속성을 통틀어 일컫는 용어이다.

  - 텍스처를 비롯한 하이레벨 속성들, 셰이더 프로그램, 셰이더 인자 등을 포함한다. 정점 속성은 메시에 포함되기에 포함되지 않는다.

  - 메시와 머터리얼만 있으면 물체를 렌더링하는 모든 정보를 갖췄기에, 메시와 머터리얼을 합쳐 **렌더 패킷**이라 부른다. 또는 **기하 기본 단위**를 메시와 머터리얼까지 확장해 쓰기도 한다.

  - 모델은 보통 여러 머터리얼을 사용하기에 메시 하나를 여러 하부 메시로 나눠 각각 머터리얼을 하나씩 연결하는 경우가 많다.

- 빛 수송 모델
  - 빛 수송 모델이란 빛-표면 및 빛-공간 간 상호작용에 관한 다양한 수학적 모델을 말한다.

  - 빛이 방출돼 물체 하나에만 반사된후 바로 카메라 상 표면에 맺히는 직접 조명만 계산에 넣는 것을 지역 조명 모델이라고 한다. 이 경우 물체들은 서로 외관에 영향을 주지 않는다.

  - 지역 조명에서 여러 표면에 여러 번 반사된 간접 조명을 계산에 넣은 것을 전역 조명 모델이라 한다. 레이 트레이싱이나 라디오시티 등이 대표적인 예시이다.

  - 전역 조명은 1986년 J.T.Kajiya가 발표한 SIGGRAPH 논문에서 소개된 렌더링 방정식이라는 수학적 공식에 의해 기술된다.  
  <https://en.wikipedia.org/wiki/Rendering_equation>

  - 전역 조명 모델 중 흔히 사용되는 것은 퐁 반사 모델로 환경(ambient)항 + 난반사(diffuse) 항 + 정반사 (specular) 항으로 표현된다.  
  퐁 반사 모델에 필요한 입력은 다음과 같다.
    - 시선 벡터 V
    - 환경광 강도 (RGB) A
    - 광선이 부딪힌 표면의 법선 N
    - 환경 · 난반사광 · 정반사광 반사율 k<sub>a</sub>, k<sub>d</sub>, k<sub>s</sub>
    - 반짝이는 정도를 나타내는 반사 지수 α
    - 각 광원 i마다 필요한 정보
      - 빛의 색과 강도(RGB) C<sub>i</sub>
      - 반사 지점에서 광원으로의 방향 벡터 L<sub>i</sub>

- 특정 지점에서 반사되는 빛의 강도  
  I = k<sub>D</sub> + Σ<sub>i</sub>[k<sub>D</sub>(N · L<sub>i</sub>) + k<sub>S</sub>(R<sub>i</sub> · V)<sup>α</sup>]C<sub>i</sub> 이다.

- R<sub>i</sub>은 N을 기준으로 광선의 방향 벡터를 나타낸 것이다.  
R = L<sub>N</sub> - L<sub>T</1sub> = L<sub>N</sub> - (L - L<sub>N</sub>) = 2(N · L)N - L 라는 수식으로 얻을 수 있다.

- 블린-퐁(Blinn-Phong) 모델은 반사광 계산식이 변형된 퐁 모델이다. 사선 벡터 V와 빛 방향 벡터 L의 정가운데 있는 벡터 H를 정의하고, 반사광 식 (R · V)<sup>α</sup>가 (N · H)<sup>a</sup>로 바꿔진다.  
지수 a는 퐁 모델의 지수 α와 다르나, 반사광 항과 비슷한 값이 되게 고른다.  
블린-퐁 모델은 정확도가 떨어지나, 속도가 더 빨라 초기 PC 게임에서 사용되었다.
